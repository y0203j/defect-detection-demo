<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Defect Detector — Demo</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <a class="skip" href="#main">Skip to main content</a>
  <header>
    <h1>Defect Detector</h1>
    <p class="lead">Accessible demo — upload a layer image and get a pass/fail + defect overlay.</p>
  </header>

  <main id="main">
    <form id="uploadForm" aria-labelledby="desc">
      <p id="desc">Upload a single layer image. Results are announced to assistive tech.</p>

      <label for="file">Image file</label>
      <input id="file" name="file" type="file" accept="image/*" required aria-required="true">

      <button id="submit" type="submit">Analyze</button>
    </form>

    <div id="status" class="status" role="status" aria-live="polite"></div>

    <section aria-labelledby="results-heading">
      <h2 id="results-heading">Results</h2>
      <div id="results" class="results" role="region" aria-live="polite"></div>
      <div id="overlayContainer" class="overlay-container" aria-hidden="false">
        <img id="overlayImg" alt="Overlay showing detected defects"/>
      </div>
    </section>
  </main>

  <footer>
    <p>Tip: Use keyboard to tab between controls. For more info, see the repository README.</p>
  </footer>

<script>
const form = document.getElementById('uploadForm');
const status = document.getElementById('status');
const results = document.getElementById('results');
const overlayImg = document.getElementById('overlayImg');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  results.innerHTML = '';
  status.textContent = 'Analyzing…';

  const fileEl = document.getElementById('file');
  const file = fileEl.files[0];
  if (!file) { status.textContent = 'Please choose a file.'; return; }

  const fd = new FormData();
  fd.append('file', file, file.name);

  try {
    const r = await fetch('/predict', { method: 'POST', body: fd });
    if (!r.ok) {
      const err = await r.json().catch(()=>({detail:'unknown'}));
      status.textContent = `Error: ${err.detail || r.statusText}`;
      return;
    }
    const data = await r.json();

    status.textContent = data.is_defective ? 'Defect detected' : 'No defect detected';

    // summary for screen readers
    results.innerHTML = `\n      <p><strong>File:</strong> ${data.filename}</p>\n      <p><strong>Defective:</strong> ${data.is_defective}</p>\n      <p><strong>Max Confidence:</strong> ${data.max_confidence}</p>\n      <p><strong>Defect area (%):</strong> ${data.defect_area_percentage}</p>\n      <p><strong>BBox:</strong> ${data.bbox ? data.bbox.join(', ') : 'None'}</p>\n    `;

    if (data.mask_image) {
      overlayImg.src = data.mask_image;
      overlayImg.alt = `Overlay showing defects for ${data.filename}`;
      overlayImg.style.display = 'block';
      overlayImg.setAttribute('aria-hidden', 'false');
    } else {
      overlayImg.style.display = 'none';
    }

  } catch (err) {
    status.textContent = 'Network or server error.';
    console.error(err);
  }
});
</script>
</body>
</html>