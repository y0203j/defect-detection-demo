<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Defect Detector V2 — Multi-Angle</title>
  <link rel="stylesheet" href="/static/styles_update.css">
  <style>
    /*inline styles for the new multi-file input layout */
    .file-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
        border: 1px solid #eee;
        padding: 15px;
        border-radius: 6px;
        background-color: #fcfcfc;
    }
    .file-input-row {
        display: flex;
        flex-direction: column;
    }
    .file-input-row label {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #555;
    }
  </style>
</head>
<body>
  <a class="skip" href="#main">Skip to main content</a>
  <header>
    <h1>Defect Detector V2</h1>
    <p class="lead">Photometric Stereo Defect Detection (Requires Angles A, B, and C)</p>
  </header>

  <main id="main">
    <form id="uploadForm" aria-labelledby="desc">
      <p id="desc">Upload the complete layer set (3 images) to analyze for defects.</p>

      <div class="file-group">
          <div class="file-input-row">
            <label for="file_a">Angle A (Left Light):</label>
            <input id="file_a" name="file_a" type="file" accept="image/*" required>
          </div>
          
          <div class="file-input-row">
            <label for="file_b">Angle B (Top/Main Light):</label>
            <input id="file_b" name="file_b" type="file" accept="image/*" required>
          </div>
          
          <div class="file-input-row">
            <label for="file_c">Angle C (Right Light):</label>
            <input id="file_c" name="file_c" type="file" accept="image/*" required>
          </div>
      </div>

      <button id="submit" type="submit">Analyze Layer</button>
    </form>

    <div id="status" class="status" role="status" aria-live="polite"></div>

    <section aria-labelledby="results-heading">
      <h2 id="results-heading">Results</h2>
      <div id="results" class="results" role="region" aria-live="polite"></div>
      <div id="overlayContainer" class="overlay-container" aria-hidden="false">
        <img id="overlayImg" alt="Overlay showing detected defects"/>
      </div>
    </section>
  </main>

  <footer>
    <p>System v2.0 | Powered by Multi-Channel MobileNetV2</p>
  </footer>

<script>
const form = document.getElementById('uploadForm');
const status = document.getElementById('status');
const results = document.getElementById('results');
const overlayImg = document.getElementById('overlayImg');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  results.innerHTML = '';
  status.textContent = 'Analyzing multi-angle data…';

  //get all 3 files
  const fileA = document.getElementById('file_a').files[0];
  const fileB = document.getElementById('file_b').files[0];
  const fileC = document.getElementById('file_c').files[0];

  if (!fileA || !fileB || !fileC) { 
      status.textContent = 'Please choose all three image angles (A, B, C).'; 
      return; 
  }

  const fd = new FormData();
  //keys must match FastAPI parameters
  fd.append('file_a', fileA);
  fd.append('file_b', fileB);
  fd.append('file_c', fileC);

  try {
    const r = await fetch('/predict', { method: 'POST', body: fd });
    if (!r.ok) {
      const err = await r.json().catch(()=>({detail:'unknown'}));
      status.textContent = `Error: ${err.detail || r.statusText}`;
      return;
    }
    const data = await r.json();

    status.textContent = data.is_defective ? 'Defect Detected!' : 'Layer is Clean';
    if(data.is_defective) status.style.color = '#d93025';
    else status.style.color = '#188038';

    //summary for screen readers and display
    results.innerHTML = `
      <p><strong>File ID:</strong> ${data.filename}</p>
      <p><strong>Status:</strong> ${data.is_defective ? 'FAIL' : 'PASS'}</p>
      <p><strong>Confidence:</strong> ${(data.max_confidence * 100).toFixed(2)}%</p>
      <p><strong>Defect Area:</strong> ${data.defect_area_percentage}%</p>
    `;

    if (data.mask_image) {
      overlayImg.src = data.mask_image;
      overlayImg.alt = `Overlay showing defects for ${data.filename}`;
      overlayImg.style.display = 'block';
    } else {
      overlayImg.style.display = 'none';
    }

  } catch (err) {
    status.textContent = 'Network or server error.';
    console.error(err);
  }
});
</script>
</body>
</html>